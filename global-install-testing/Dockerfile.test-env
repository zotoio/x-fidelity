# Clean test environment for global x-fidelity CLI testing
FROM registry.access.redhat.com/ubi9/ubi:latest

# Install Node.js 22 and required system dependencies
RUN dnf update -y && \
    dnf install -y --allowerasing \
    curl \
    git \
    gcc \
    gcc-c++ \
    make \
    python3 \
    python3-pip \
    bash \
    jq && \
    dnf clean all

# Install Node.js 22
RUN curl -fsSL https://rpm.nodesource.com/setup_22.x | bash - && \
    dnf install -y nodejs

# Install Yarn
RUN npm install -g yarn

# Install BATS testing framework
RUN cd /tmp && \
    git clone https://github.com/bats-core/bats-core.git && \
    cd bats-core && \
    ./install.sh /usr/local && \
    cd / && rm -rf /tmp/bats-core

# Install BATS helpers
RUN cd /tmp && \
    git clone https://github.com/bats-core/bats-support.git && \
    git clone https://github.com/bats-core/bats-assert.git && \
    mkdir -p /usr/local/lib/bats && \
    mv bats-support /usr/local/lib/bats/ && \
    mv bats-assert /usr/local/lib/bats/ && \
    rm -rf /tmp/bats-*

# Create test workspace
WORKDIR /test-workspace

# Set up environment
ENV PATH="/usr/local/bin:$PATH"
ENV NODE_ENV=test

# Default command runs bash for interactive testing
CMD ["/bin/bash"]